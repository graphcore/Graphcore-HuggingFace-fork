#!/bin/bash
# Copyright (c) 2022 Graphcore Ltd. All rights reserved.
# Script to be sourced on launch of the Gradient Notebook

# called from root folder in container
# SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

echo "Graphcore setup - Starting notebook setup"
DETECTED_NUMBER_OF_IPUS=$(python .gradient/available_ipus.py)
if [[ "$1" == "test" ]]; then
    IPU_ARG="${DETECTED_NUMBER_OF_IPUS}"
else
    IPU_ARG=${1:-"${DETECTED_NUMBER_OF_IPUS}"}
fi
echo "Graphcore setup - Detected ${DETECTED_NUMBER_OF_IPUS} IPUs"
if [[ "${DETECTED_NUMBER_OF_IPUS}" == "0" ]]; then
    echo "=============================================================================="
    echo "                         ERROR  DETECTED"
    echo "=============================================================================="
    echo "Connection to IPUs timed-out. This error indicates a problem with the "
    echo "hardware you are running on. Please contact Paperspace Support at "
    echo " https://docs.paperspace.com/contact-support/ "
    echo " referencing the Notebook ID: ${PAPERSPACE_METRIC_WORKLOAD_ID:-unknown}"
    echo "=============================================================================="
    exit -1
fi

export NUM_AVAILABLE_IPU=${IPU_ARG}
export GRAPHCORE_POD_TYPE="pod${IPU_ARG}"
export POPLAR_EXECUTABLE_CACHE_DIR="/tmp/exe_cache"
export DATASETS_DIR="/tmp/dataset_cache"
export CHECKPOINT_DIR="/tmp/checkpoints"
export PIP_DISABLE_PIP_VERSION_CHECK=1
export CACHE_DIR="/tmp"

# mounted public dataset directory (path in the container)
# in the Paperspace environment this would be ="/datasets"
export PUBLIC_DATASETS_DIR="/datasets"

export HUGGINGFACE_HUB_CACHE="/tmp/huggingface_caches"
export TRANSFORMERS_CACHE="/tmp/huggingface_caches/checkpoints"
export HF_DATASETS_CACHE="/tmp/huggingface_caches/datasets"

# Set framework specific variables
export POPTORCH_CACHE_DIR="${POPLAR_EXECUTABLE_CACHE_DIR}"
export POPTORCH_LOG_LEVEL=ERR
export RDMAV_FORK_SAFE=1

# source custom popart build. Since it was build in a local pod, this will set some env vars like PATH to
# have the wrong values, so they are modified below
CBT_IGNORE_SDK=1 source /storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/activate.sh
export CBT_BUILDTREE=/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release
export CMAKE_PREFIX_PATH=/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/host_runtime_version:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/icu_types:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sqlite:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/googletest:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pybind11:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sphinx_resources:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/nlohmann_json:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gccs:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mimalloc:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/linux:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/trompeloeil:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/capnproto:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/zoltan:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/numactl:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/spdlog:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libusb:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/colossus_tools_version:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/elfio:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/arcanist_linters:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/compilercaps:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcdoc:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/cbt:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/indicators:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/protobuf:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_protos:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/catch2:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libdivide:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpva:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/assembler:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_binary:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/grpc:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/onnx:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pcie_driver:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/windows_driver:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hwloc:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch_mk2:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/docs_poplar:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mocksea:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpvti:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprithms:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/usb_driver:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/tbb:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/openmpi:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipu_sim:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/exchange:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipuof_lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_target_access:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hw_testing:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplibs:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popef:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/model_runtime:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popdist:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/snap:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcl:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popart:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_benchmarks:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprun:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_packaging
export PYTHONPATH=/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/host_runtime_version/lib/python:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/host_runtime_version/python:/opt/popart/python:/opt/poplar/python:/opt/poplar/lib/python
export LIBRARY_PATH=/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/host_runtime_version/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/icu_types/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sqlite/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/googletest/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pybind11/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sphinx_resources/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/nlohmann_json/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gccs/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mimalloc/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/linux/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/trompeloeil/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/capnproto/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/zoltan/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/numactl/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/spdlog/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libusb/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/colossus_tools_version/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/elfio/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/arcanist_linters/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/compilercaps/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcdoc/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/cbt/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/indicators/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/protobuf/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_protos/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/catch2/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libdivide/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpva/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/assembler/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_binary/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/grpc/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/onnx/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pcie_driver/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/windows_driver/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hwloc/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch_mk2/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/docs_poplar/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mocksea/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpvti/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprithms/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/usb_driver/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/tbb/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_lib/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/openmpi/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipu_sim/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/exchange/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipuof_lib/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_target_access/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hw_testing/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplibs/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popef/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/model_runtime/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popdist/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/snap/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcl/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popart/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_benchmarks/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprun/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_packaging/lib
export LD_LIBRARY_PATH=/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/host_runtime_version/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/icu_types/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sqlite/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/googletest/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pybind11/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sphinx_resources/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/nlohmann_json/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gccs/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mimalloc/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/linux/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/trompeloeil/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/capnproto/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/zoltan/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/numactl/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/spdlog/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libusb/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/colossus_tools_version/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/elfio/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/arcanist_linters/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/compilercaps/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcdoc/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/cbt/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/indicators/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/protobuf/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_protos/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/catch2/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libdivide/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpva/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/assembler/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_binary/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/grpc/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/onnx/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pcie_driver/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/windows_driver/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hwloc/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch_mk2/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/docs_poplar/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mocksea/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpvti/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprithms/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/usb_driver/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/tbb/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_lib/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/openmpi/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipu_sim/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/exchange/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipuof_lib/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_target_access/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hw_testing/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplibs/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popef/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/model_runtime/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popdist/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/snap/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcl/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popart/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_benchmarks/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprun/lib:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_packaging/lib
export PATH=/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/host_runtime_version/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/icu_types/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sqlite/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/googletest/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pybind11/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sphinx_resources/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/nlohmann_json/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gccs/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mimalloc/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/linux/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/trompeloeil/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/capnproto/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/zoltan/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/numactl/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/spdlog/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libusb/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/colossus_tools_version/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/elfio/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/arcanist_linters/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/compilercaps/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcdoc/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/cbt/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/indicators/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/protobuf/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_protos/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/catch2/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libdivide/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpva/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/assembler/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_binary/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/grpc/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/onnx/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pcie_driver/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/windows_driver/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hwloc/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch_mk2/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/docs_poplar/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mocksea/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpvti/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprithms/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/usb_driver/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/tbb/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_lib/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/openmpi/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipu_sim/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/exchange/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipuof_lib/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_target_access/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hw_testing/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplibs/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popef/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/model_runtime/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popdist/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/snap/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcl/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popart/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_benchmarks/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprun/bin:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_packaging/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export CPATH=/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/host_runtime_version/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/icu_types/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sqlite/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/googletest/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pybind11/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/sphinx_resources/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/nlohmann_json/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gccs/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mimalloc/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/linux/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/trompeloeil/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/capnproto/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/zoltan/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/numactl/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/spdlog/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libusb/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/colossus_tools_version/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/elfio/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/arcanist_linters/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/compilercaps/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcdoc/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/cbt/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/indicators/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/protobuf/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_protos/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/catch2/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libdivide/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpva/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/assembler/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_binary/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/grpc/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/onnx/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/pcie_driver/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/windows_driver/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hwloc/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch_mk2/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/docs_poplar/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/mocksea/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/soc_arch/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/libpvti/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprithms/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/usb_driver/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/tbb/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/vipu_lib/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/openmpi/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipu_sim/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/exchange/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/ipuof_lib/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/graphcore_target_access/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/hw_testing/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplibs/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popef/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/model_runtime/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popdist/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/snap/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/gcl/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/popart/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_benchmarks/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poprun/include:/storage/custom_popart_build/custom_popart_build/workspace/poplar/build_release/install/poplar_packaging/include


echo "Graphcore setup - Spawning dataset preparation process"
nohup /notebooks/.gradient/prepare-datasets.sh ${@} & tail -f nohup.out &

export PIP_DISABLE_PIP_VERSION_CHECK=1 CACHE_DIR=/tmp
echo "Graphcore setup - Starting Jupyter kernel"
jupyter lab --allow-root --ip=0.0.0.0 --no-browser --ServerApp.trust_xheaders=True \
            --ServerApp.disable_check_xsrf=False --ServerApp.allow_remote_access=True \
            --ServerApp.allow_origin='*' --ServerApp.allow_credentials=True
